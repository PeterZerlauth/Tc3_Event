<?xml version="1.0" encoding="utf-8"?>
<TcPlcObject Version="1.1.0.1">
  <POU Name="FB_File" Id="{879562f4-6da1-45fb-a1f3-48bd69fd0a1e}" SpecialFunc="None">
    <Declaration><![CDATA[FUNCTION_BLOCK FB_File
VAR_INPUT
END_VAR
VAR_OUTPUT
    pBuffer:				POINTER TO BYTE;
    nBuffer:				UDINT;	
	bOpen:					BOOL;
	bError:					BOOL;
END_VAR
VAR
    hFile: 					SysFile.SysTypes.RTS_IEC_HANDLE;
	nResult:				SysFile.SysTypes.RTS_IEC_RESULT;
	nState:					SysFile.SYS_FILE_STATUS;
	{attribute 'hide'} 
	pResult:				POINTER TO SysFile.SysTypes.RTS_IEC_RESULT:= ADR(nResult);
END_VAR
]]></Declaration>
    <Implementation>
      <ST><![CDATA[// https://peterzerlauth.com/]]></ST>
    </Implementation>
    <Method Name="M_Close" Id="{2032b7d9-4eba-4de7-bc38-d769b85ee782}">
      <Declaration><![CDATA[// Closes the currently opened file.
METHOD PUBLIC M_Close : BOOL
VAR_INPUT
END_VAR]]></Declaration>
      <Implementation>
        <ST><![CDATA[IF hFile <> 0 THEN
   nResult:= SysFile.SysFileClose(hFile);
   IF nResult = 0 THEN
	   hFile:= 0;
	   M_Close:= TRUE;
   ELSE
	    bError := TRUE;
   END_IF
END_IF]]></ST>
      </Implementation>
    </Method>
    <Method Name="M_Delete" Id="{031610a1-66f5-45ab-8b86-edea27263a7f}">
      <Declaration><![CDATA[// Delete file
METHOD PUBLIC M_Delete : BOOL
VAR_INPUT
    sFileName : STRING(255);
END_VAR]]></Declaration>
      <Implementation>
        <ST><![CDATA[bError := FALSE;
nResult := 0; 

// CHANGED: If we have this file open, close it before deleting.
IF bOpen AND hFile <> SysFile.SysTypes.RTS_INVALID_HANDLE THEN
    // Note: This assumes sFileName is the same file as the one open.
    // A more complex FB might check this.
    M_Close(); 
END_IF

pResult^:= SysFile.SysFileDelete(sFileName);
bError := (nResult <> 0);
M_Delete:= NOT bError; // CHANGED: Return actual success]]></ST>
      </Implementation>
    </Method>
    <Method Name="M_GetSize" Id="{da2b00f7-d9aa-4c86-85c6-4fdbc9147466}">
      <Declaration><![CDATA[METHOD PUBLIC M_GetSize : UDINT
VAR_INPUT
END_VAR
]]></Declaration>
      <Implementation>
        <ST><![CDATA[IF hFile = SysFile.SysTypes.RTS_INVALID_HANDLE THEN
    RETURN;
END_IF

M_GetSize:= LWORD_TO_UDINT(SysFile.SysFileGetSizeByHandle(hFile, pResult));

IF nResult <> 0 THEN
	bError := TRUE;
END_IF]]></ST>
      </Implementation>
    </Method>
    <Method Name="M_Open" Id="{6307849d-083a-4a2a-8a54-cacfa983025c}">
      <Declaration><![CDATA[// Open file
METHOD PUBLIC M_Open : BOOL
VAR_INPUT
    sFileName:				STRING(255);
	eMode: 					SysFile.ACCESS_MODE := SysFile.AM_APPEND_PLUS;
END_VAR
]]></Declaration>
      <Implementation>
        <ST><![CDATA[IF hFile = 0 THEN
	hFile := SysFile.SysFileOpen(sFileName, eMode, pResult);
	IF hFile = SysFile.SysTypes.RTS_INVALID_HANDLE  THEN
		bError := TRUE;
		RETURN;
	END_IF

   if nResult = 0 then
	   M_Open:= TRUE;
   ELSE
	    bError := TRUE;
   END_IF
END_IF]]></ST>
      </Implementation>
    </Method>
    <Method Name="M_Read" Id="{4210ba0d-c339-4c83-b89a-8d5ea8fd601c}">
      <Declaration><![CDATA[// Read file
METHOD PUBLIC M_Read : BOOL
VAR_INPUT
END_VAR]]></Declaration>
      <Implementation>
        <ST><![CDATA[bError := FALSE;
nResult := 0;

// CHANGED: Added guard condition
IF NOT bOpen THEN
    bError := TRUE;
    nResult := 16#FFFF; // Custom error: File not open
    M_Read := FALSE;
    RETURN;
END_IF

// Clean up old buffer before reading new content
IF pBuffer <> 0 THEN
	__DELETE(pBuffer);
	nBuffer:= 0;
END_IF

nBuffer:= M_GetSize(); // This method now sets bError/nResult

IF bError THEN // M_GetSize failed
    M_Read := FALSE;
    RETURN;
END_IF

IF nBuffer > 0 THEN
    pBuffer:= __NEW(BYTE, nBuffer);
    
    // CHANGED: Check if memory allocation failed
    IF pBuffer = 0 THEN
        bError := TRUE;
        nResult := 16#FFFD; // Custom error: Out of memory
        nBuffer := 0;
        M_Read := FALSE;
        RETURN;
    END_IF
    
    SysFile.SysFileRead(hFile, pBuffer, nBuffer, pResult );
ELSE
    // File is empty (nBuffer = 0), this is not an error.
    pBuffer := 0;
END_IF

bError := (nResult <> 0);
M_Read := NOT bError; // CHANGED: Return actual success]]></ST>
      </Implementation>
    </Method>
    <Method Name="M_Status" Id="{8f0ab01f-d98a-40bc-9f73-79c89b4ed20b}">
      <Declaration><![CDATA[// Closes the currently opened file.
METHOD PUBLIC M_Status : BOOL
VAR_INPUT
END_VAR]]></Declaration>
      <Implementation>
        <ST><![CDATA[bError := FALSE;
nResult := 0; // This function does not use pResult

IF hFile <> SysFile.SysTypes.RTS_INVALID_HANDLE THEN
   nState := SysFile.SysFileGetStatus(hFile); // CHANGED: Write to output [cite: 14]
   M_Status:= TRUE;
ELSE
   nState := 0; // Clear state
   M_Status := FALSE; // CHANGED: Return false if not open
   bOpen := FALSE;
END_IF]]></ST>
      </Implementation>
    </Method>
    <Method Name="M_Write" Id="{b956b515-594f-440e-be50-f979325c8ffe}">
      <Declaration><![CDATA[// Writes the contents of the buffer into a file.
METHOD PUBLIC M_Write : BOOL
VAR_INPUT
	pBuffer:	POINTER TO BYTE;
    nSize:     	UDINT;
END_VAR]]></Declaration>
      <Implementation>
        <ST><![CDATA[IF pBuffer = 0 OR nSize = 0 THEN
    RETURN;
END_IF

IF hFile <> 0 THEN
	SysFile.SysFileWrite(hFile := hFile, pbyBuffer := pBuffer, ulSize := nSize, pResult := pResult);
END_IF

IF nResult = 0 THEN
	M_Write := TRUE;
ELSE
	bError:= TRUE;
END_IF]]></ST>
      </Implementation>
    </Method>
  </POU>
</TcPlcObject>